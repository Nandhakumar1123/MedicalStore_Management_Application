<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medicines & Stock Alerts</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #007bff, #00c6ff); color: white; padding: 20px; text-align: center; font-size: 28px; font-weight: bold; }
    nav { background: #0056b3; padding: 12px; text-align: center; }
    nav a { color: white; margin: 0 15px; text-decoration: none; font-weight: bold; font-size: 16px; transition: 0.3s; }
    nav a:hover { color: #ffd700; }
    h1 { text-align: center; color: #333; margin-top: 20px; }
    #searchBar { display: block; margin: 20px auto; padding: 10px; width: 50%; border: 1px solid #ccc; border-radius: 8px; }
    #stats { display:flex; justify-content:center; gap:20px; margin:20px auto; font-weight:bold; color:#333; }
    #alertBox { width: 80%; margin: 20px auto; background: #fff3cd; border: 1px solid #ffecb5; padding: 15px; border-radius: 8px; display: none; }
    #alertList { color: #b02a37; font-weight: bold; }
    table { width: 90%; margin: 20px auto; border-collapse: collapse; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
    th { background: #007bff; color: #fff; cursor:pointer; }
    tr.expired { background: #f8d7da; }
    tr.expiring-soon { background: #fff3cd; }
    tr.low-stock { background: #f5c6cb; }
    .badge { padding:4px 8px; border-radius:6px; font-size:12px; color:white; }
    .expired-badge { background:#dc3545; }
    .expiring-badge { background:#ffc107; color:#000; }
    .low-badge { background:#17a2b8; }
    #printBtn { display:block; margin:10px auto; padding:10px 20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; }
    #printBtn:hover { background:#218838; }
    footer { background: #0056b3; color: white; padding: 15px; text-align: center; margin-top: 30px; font-size: 14px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>Medical Store Management System</header>

  <!-- Navigation -->
  <nav>
    <a href="/dashboard">Dashboard</a>
    <a href="/medicines">Medicines</a>
    <a href="/add_medicine">Add Medicines</a>
    <a href="/billing">Billing</a>
    <a href="/medicine_arrivals">Arrivals</a>
    <a href="/report">Reports</a>
    <a href="/medicine_stock">Stock</a>
  </nav>

  <!-- Main content -->
  <h1>All Medicines & Stock Alerts</h1>
  <input type="text" id="searchBar" placeholder="Search medicine...">

  <!-- Stats -->
  <div id="stats">
    <div>Total Medicines: <span id="totalMeds">0</span></div>
    <div>Low Stock: <span id="lowCount">0</span></div>
    <div>Expiring Soon: <span id="expCount">0</span></div>
  </div>

  <h2 style="text-align:center; color:red;">‚ö†Ô∏è Alerts</h2>
  <div id="alertBox">
    <ul id="alertList"></ul>
  </div>

  <!-- ‚úÖ Print button instead of Download -->
  <button id="printBtn">üñ® Print Report</button>

  <table id="MedicineTable">
    <tr>
      <th onclick="sortTable(0)">Name ‚¨ç</th>
      <th onclick="sortTable(1)">Expiry Date ‚¨ç</th>
      <th onclick="sortTable(2)">Quantity ‚¨ç</th>
      <th onclick="sortTable(3)">Price ‚¨ç</th>
      <th>Status</th>
    </tr>
  </table>

  <!-- Script -->
  <script>
    fetch("/api/medicines")
    .then(res => res.json())
    .then(data => {
      const table = document.getElementById("MedicineTable");
      const today = new Date();
      const alertBox = document.getElementById("alertBox");
      const alertList = document.getElementById("alertList");
      let alerts = [];
      let lowCount=0, expCount=0;

      data.medicines.forEach(med => {
        const expiry = new Date(med.expiry_date);
        const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        const row = table.insertRow();
        let status="";

        if (daysLeft < 0) {
          row.classList.add("expired");
          alerts.push(`${med.name} has already expired!`);
          status = '<span class="badge expired-badge">Expired</span>';
          expCount++;
        } else if (daysLeft <= 10) {
          row.classList.add("expiring-soon");
          alerts.push(`${med.name} is expiring in ${daysLeft} days!`);
          status = '<span class="badge expiring-badge">Expiring Soon</span>';
          expCount++;
        }
        if (med.quantity < 7) {
          row.classList.add("low-stock");
          alerts.push(`${med.name} stock is low (only ${med.quantity} left).`);
          status += ' <span class="badge low-badge">Low Stock</span>';
          lowCount++;
        }

        row.innerHTML = `
          <td>${med.name}</td>
          <td>${med.expiry_date}</td>
          <td>${med.quantity}</td>
          <td>‚Çπ ${med.price}</td>
          <td>${status || "‚úî OK"}</td>
        `;
      });

      // Stats update
      document.getElementById("totalMeds").textContent = data.medicines.length;
      document.getElementById("lowCount").textContent = lowCount;
      document.getElementById("expCount").textContent = expCount;

      // Show alerts
      if (alerts.length > 0) {
        alertBox.style.display = "block";
        alerts.forEach(msg => {
          const li = document.createElement("li");
          li.textContent = msg;
          alertList.appendChild(li);
        });
      }

      // Search filter
      document.getElementById("searchBar").addEventListener("keyup", function() {
        const filter = this.value.toLowerCase();
        const rows = table.getElementsByTagName("tr");
        for (let i = 1; i < rows.length; i++) {
          let td = rows[i].getElementsByTagName("td")[0];
          if (td) {
            let textValue = td.textContent || td.innerText;
            rows[i].style.display = textValue.toLowerCase().includes(filter) ? "" : "none";
          }
        }
      });
    });

    // ‚úÖ Print Report
    document.getElementById("printBtn").addEventListener("click", () => {
      window.print();
    });

    // Sorting
    function sortTable(n) {
      const table = document.getElementById("MedicineTable");
      let switching = true, dir = "asc", switchcount = 0;
      while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
          let shouldSwitch = false;
          let x = rows[i].getElementsByTagName("td")[n];
          let y = rows[i + 1].getElementsByTagName("td")[n];
          if (!x || !y) continue;
          if (dir === "asc" && x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
            shouldSwitch = true; break;
          }
          if (dir === "desc" && x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
            shouldSwitch = true; break;
          }
        }
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount++;
        } else {
          if (switchcount === 0 && dir === "asc") { dir = "desc"; switching = true; }
        }
      }
    }
  </script>

  <!-- Footer -->
  <footer>
    &copy; 2025 Medical Store | Nandhakumar
  </footer>
</body>
</html>
